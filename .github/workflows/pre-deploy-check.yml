name: Pre-Deployment Safety Check

on:
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      strict:
        description: 'Strict mode (fail on warnings)'
        required: false
        default: false
        type: boolean

jobs:
  preflight:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Install frontend dependencies
        run: |
          cd frontend && npm ci

      - name: Validate secrets
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::error::DATABASE_URL secret is not configured. Go to repo Settings > Secrets > Actions to add it."
            exit 1
          fi
          echo "All required secrets are configured."
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run preflight checks
        continue-on-error: true
        run: |
          TARGET="${{ github.event.inputs.target || 'staging' }}"
          STRICT_FLAG=""
          if [ "${{ github.event.inputs.strict }}" = "true" ]; then
            STRICT_FLAG="--strict"
          fi
          python scripts/deploy_preflight.py \
            --target "$TARGET" \
            --skip-vercel \
            --output /tmp/preflight_report.json \
            $STRICT_FLAG \
            -v
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Upload preflight report
        uses: actions/upload-artifact@v4
        with:
          name: preflight-report
          path: /tmp/preflight_report.json
          retention-days: 30
        if: always()

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('/tmp/preflight_report.json', 'utf8'));
            } catch (e) {
              report = { decision: 'UNKNOWN', total_issues: -1 };
            }
            const icon = report.decision === 'GO' ? ':white_check_mark:' :
                         report.decision?.startsWith('GO') ? ':warning:' : ':x:';
            const body = `## ${icon} Pre-Deployment Check: ${report.decision || 'UNKNOWN'}

            **Target:** ${report.target || 'staging'}
            **Issues:** ${report.total_issues || 0}
            **Warnings:** ${report.total_warnings || 0}

            ${(report.issues || []).map(i => `- :x: ${i}`).join('\n')}
            ${(report.warnings || []).slice(0, 5).map(w => `- :warning: ${w}`).join('\n')}

            > Generated by \`/deploy-check\` agent`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
